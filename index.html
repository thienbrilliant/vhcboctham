<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Viet Haxball Cup | SS14 - Bốc Thăm</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#031224; --accent:#00c2ff; --gold:#ffd54d; --muted:#9fb8cc;
  --potA-grad: linear-gradient(180deg,#00c2ff,#0086d1);
  --potB-grad: linear-gradient(180deg,#ffd54d,#ffb400);
  --potC-grad: linear-gradient(180deg,#a7ff83,#32d74b);
  --high-contrast: #ffffff;
}
/* Global reset & no scroll (broadcast-ready) */
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow:hidden;background:linear-gradient(180deg,#021726,#031224);font-family:Inter,system-ui,Roboto,Arial;color:#e8f9ff;-webkit-font-smoothing:antialiased}
.container{height:100vh;display:grid;grid-template-rows:10vh 40vh 20vh 30vh;padding:12px;gap:10px;max-width:1920px;margin:0 auto}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;padding:6px 18px}
.brand{font-family:Orbitron;font-weight:800;color:var(--accent);font-size:20px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#021322;border:none;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.toggle{color:var(--muted);font-size:13px}

/* bracket */
.bracket{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 28px 80px rgba(0,0,0,0.6);overflow:hidden}
.bracket .title{font-family:Orbitron;color:var(--gold);font-weight:700;font-size:18px}
.pair-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;height:100%;align-content:start;padding:6px}
.pair{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:64px;display:flex;flex-direction:column;justify-content:center}
.pair-row{display:flex;align-items:center;justify-content:space-between}
.slot{display:flex;gap:10px;align-items:center}
.mini{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,#022434,#05354a);color:var(--muted);font-weight:800}
.name{font-weight:800;color:#dff7ff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.vs{color:var(--muted);font-weight:800}

/* reveal region (main small card visible) */
.reveal-zone{display:flex;align-items:center;justify-content:center}
.reveal-card{width:80%;height:90%;border-radius:14px;background:linear-gradient(180deg,#022c34,#03282f);display:flex;align-items:center;justify-content:space-between;gap:24px;padding:22px;box-shadow:0 40px 160px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
.reveal-ball{width:220px;height:220px;border-radius:50%;display:grid;place-items:center;font-family:Orbitron;font-weight:900;font-size:28px;background:var(--potA-grad);color:#021322;box-shadow:0 60px 200px rgba(0,0,0,0.6)}
.reveal-logo{width:100%;height:100%;border-radius:50%;object-fit:cover;display:block}

/* text next to reveal circle */
.reveal-text{color:#dff7ff;font-size:20px;font-weight:700;max-width:48%;text-align:left;display:flex;flex-direction:column;gap:8px}
.reveal-text .big{font-size:22px;font-weight:900}
.reveal-text .small{color:var(--muted);font-weight:600;font-size:13px}

/* pots bottom */
.pots-row{display:flex;align-items:center;justify-content:space-around;gap:20px;padding:8px;height:100%}
.pot{width:30%;height:100%;border-radius:12px;background:linear-gradient(180deg,#072b38,#063246);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;padding:12px;position:relative;box-shadow:0 18px 60px rgba(0,0,0,0.6)}
.pot h4{margin:0;color:var(--gold);font-family:Orbitron;font-weight:700}
.pot-bowl{width:100%;flex:1;display:flex;align-items:center;justify-content:space-evenly;gap:10px;flex-wrap:nowrap}
.ball{width:84px;height:84px;border-radius:50%;display:grid;place-items:center;font-weight:900;color:#021322;box-shadow:0 30px 100px rgba(0,0,0,0.6);cursor:pointer;border:4px solid rgba(255,255,255,0.12)}
.ball.potA{background:var(--potA-grad); border-color: rgba(255,255,255,0.95)}
.ball.potB{background:var(--potB-grad); border-color: rgba(255,255,255,0.95)}
.ball.potC{background:var(--potC-grad); border-color: rgba(255,255,255,0.95)}
.ball.hidden{color:transparent}
.pot .count{position:absolute;right:12px;bottom:12px;color:var(--muted);font-size:13px}

/* reveal overlay (big) */
.reveal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;pointer-events:auto;z-index:12000;background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75))}
.reveal-full{width:min(980px,94%);height:480px;border-radius:14px;background:linear-gradient(180deg,#012022,#02242a);display:flex;align-items:center;justify-content:center;gap:24px;padding:20px;box-shadow:0 60px 200px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.04)}
.rball{width:320px;height:320px;border-radius:50%;display:grid;place-items:center;font-family:Orbitron;font-weight:900;font-size:34px;background:linear-gradient(180deg,#00e0ff,#006fb8);color:#021322;box-shadow:0 80px 260px rgba(0,0,0,0.7);overflow:hidden}
.rlogo{width:100%;height:100%;object-fit:cover;border-radius:50%;display:block}
.rtext{color:#e6fffe;font-weight:800;font-size:20px}

/* cinematic effects */
@keyframes ballUltraSpin {0%{transform:scale(.55)rotate(0)}40%{transform:scale(1.14)rotate(720deg)}70%{transform:scale(.98)rotate(1080deg)}100%{transform:scale(1)rotate(1440deg)}}
@keyframes ballExplosion {0%{box-shadow:0 0 0 rgba(255,255,255,0)}100%{box-shadow:0 0 30px rgba(0,194,255,0.95),0 0 100px rgba(255,213,77,0.95),0 0 200px rgba(255,255,255,0.6)}}
@keyframes textRevealEpic {0%{opacity:0;transform:scale(.4);filter:blur(6px)}60%{opacity:1;transform:scale(1.08)}100%{transform:scale(1)}}
@keyframes dropFade {0%{transform:translateY(-40px);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes bracketGlowStrong {0%{box-shadow:0 0 0 rgba(255,213,77,0)}100%{box-shadow:0 0 30px rgba(255,213,77,1)}}
@keyframes cameraShake {0%{transform:translate(0,0)}20%{transform:translate(-6px,3px)}40%{transform:translate(5px,-3px)}60%{transform:translate(-3px,4px)}80%{transform:translate(2px,-1px)}100%{transform:translate(0,0)}}

/* wizard modal (full screen, OS-install style) */
.wizard-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.85));z-index:13000;display:flex;align-items:center;justify-content:center}
.wizard{width:min(980px,94%);background:#061425;border-radius:14px;padding:18px;color:#e8f9ff;box-shadow:0 40px 140px rgba(0,0,0,0.7)}
.wiz-step{display:none}
.wiz-step.active{display:block}
.wiz-nav{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.option-grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.option{padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
.opt-selected{box-shadow:0 8px 34px rgba(0,0,0,0.6);border-color:var(--accent);background:linear-gradient(180deg, rgba(0,194,255,0.06), rgba(0,194,255,0.02))}
.team-list{max-height:320px;overflow:auto;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-top:12px}
.team-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px}
.team-item img{width:36px;height:36px;border-radius:50%;object-fit:cover}

/* responsiveness */
@media (max-width:1200px){ .pair-grid{grid-template-columns:repeat(2,1fr)} .pot{width:95%} .reveal-full{height:420px} .rball{width:220px;height:220px;font-size:20px} .reveal-card{flex-direction:column;gap:12px} }

</style>
</head>
<body>
  <div class="container" id="app">
    <!-- header -->
    <div class="header">
      <div class="brand">Viet Haxball Cup | SS14 - Bốc Thăm</div>
      <div class="controls">
        <button id="openWizard" class="btn ghost">Cài Đặt</button>
        <button id="btnExport" class="btn ghost">Xuất</button>
        <button id="btnUndo" class="btn ghost">Hoàn Tác</button>
        <button id="btnObs" class="btn ghost">OBS: OFF</button>
        <label class="toggle"><input id="musicToggle" type="checkbox"> Music</label>
      </div>
    </div>

    <!-- bracket -->
    <div class="bracket">
      <div class="title">Bracket - Các cặp đấu</div>
      <div class="pair-grid" id="pairGrid"></div>
    </div>

    <!-- reveal (MAIN visible area) -->
    <div class="reveal-zone">
      <div class="reveal-card" id="revealCard" aria-hidden="true">
        <div class="reveal-ball" id="revealBall" aria-hidden="true">
          <!-- logo img goes here if available -->
        </div>
        <div class="reveal-text" id="revealText">
          <div class="big" id="revealName">MỞ QUẢ BÓNG...</div>
          <div class="small" id="revealSub">Click quả bóng để bốc</div>
        </div>
      </div>
    </div>

    <!-- pots -->
    <div class="pots-row">
      <div class="pot" id="potA"><h4>Pot A</h4><div class="pot-bowl" id="bowlA"></div><div class="count" id="countA">0</div></div>
      <div class="pot" id="potB"><h4>Pot B</h4><div class="pot-bowl" id="bowlB"></div><div class="count" id="countB">0</div></div>
      <div class="pot" id="potC"><h4>Pot C</h4><div class="pot-bowl" id="bowlC"></div><div class="count" id="countC">0</div></div>
    </div>
  </div>

  <!-- reveal overlay (persistent until dismiss) -->
  <div id="revealOverlay" class="reveal-overlay" style="display:none">
    <div class="reveal-full" id="revealFullCard" role="dialog">
      <div class="rball" id="rball" aria-hidden="true"></div>
      <div style="display:flex;flex-direction:column;gap:12px;align-items:flex-start;">
        <div class="rtext" id="rtext">Đang mở quả bóng...</div>
        <div style="display:flex;gap:8px;">
          <button id="dismissReveal" class="btn">Dismiss</button>
          <button id="keepReveal" class="btn ghost">Keep (lock)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- wizard modal -->
  <div id="wizard" class="wizard-backdrop" style="display:flex">
    <div class="wizard" role="dialog" aria-modal="true">
      <!-- Step 1: Choose cycle -->
      <div class="wiz-step active" data-step="1" id="wizStep1">
        <h2>1/3 — Chọn Cycle Bốc Thăm</h2>
        <div class="option-grid" id="cycleOptions">
          <div class="option option-cycle" data-cycle="cycle1">Cycle 1</div>
          <div class="option option-cycle" data-cycle="cycle3.2">Cycle 3.2</div>
          <div class="option option-cycle" data-cycle="cycle3.3">Cycle 3.3</div>
        </div>
        <div class="wiz-nav">
          <div></div>
          <div><button id="wizNext1" class="btn">Next →</button></div>
        </div>
      </div>

      <!-- Step 2: Choose number of teams -->
      <div class="wiz-step" data-step="2" id="wizStep2">
        <h2>2/3 — Chọn số đội dùng cho lần bốc này</h2>
        <div class="option-grid" id="numOptions"></div>
        <div style="margin-top:8px;color:var(--muted)">Chọn số đội (từ 6 đến 14)</div>
        <div class="wiz-nav">
          <button id="wizBack2" class="btn ghost">← Back</button>
          <button id="wizNext2" class="btn">Next →</button>
        </div>
      </div>

      <!-- Step 3: Select teams (checkbox) -->
      <div class="wiz-step" data-step="3" id="wizStep3">
        <h2>3/3 — Chọn danh sách đội (tick những đội sẽ tham gia lần bốc này)</h2>
        <div id="teamCountInfo" style="color:var(--muted);margin-top:6px"></div>
        <div class="team-list" id="teamList"></div>
        <div style="margin-top:12px;display:flex;justify-content:space-between">
          <button id="wizBack3" class="btn ghost">← Back</button>
          <div><button id="wizFinish" class="btn">Apply & Start</button></div>
        </div>
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti"></div>

  <!-- audio -->
  <audio id="audioDrum" src="https://www.soundjay.com/misc/sounds/drum-roll-1.mp3" preload="auto"></audio>
  <audio id="audioPop" src="https://www.soundjay.com/button/sounds/button-16.mp3" preload="auto"></audio>
  <audio id="audioApplause" src="https://www.soundjay.com/human/sounds/applause-8.mp3" preload="auto"></audio>
  <audio id="audioGasp" src="https://www.soundjay.com/human/sounds/gasp-1.mp3" preload="auto"></audio>
  <audio id="audioBG" src="assets/epic.mp3" preload="auto" loop></audio>

<script>
/* =============================
  Full index.html logic
  - Wizard settings (3 steps)
  - Dynamic pot distribution based on selected team count
  - Random draw, balls colored per pot (gradient)
  - Logo displayed in circular crop (cover)
  - Reveal overlay: spin -> explosion -> reveal -> wait for Dismiss
  - On Dismiss: animate drop into bracket and update main reveal card with logo+name
  - Prevent pairing repeats across cycles using localStorage
  - Undo & Export
  - Hotkeys: 1/2/3 = draw from pot A/B/C, Space = Dismiss, U = Undo, X = Export
================================= */

const MAX = 14;
let allTeams = []; // from teams.json
let selectedTeams = []; // teams selected for current draw
let pots = [[],[],[]]; // each element: {id,name,logo,pot}
let history = []; // events logged
let currentCycle = 'cycle1';
let selectedCount = 14;
let currentDraw = null; // {team, assigned}
let lastLocked = false;

/* DOM refs */
const wizard = document.getElementById('wizard');
const cycleOptions = document.getElementById('cycleOptions');
const numOptions = document.getElementById('numOptions');
const teamList = document.getElementById('teamList');
const teamCountInfo = document.getElementById('teamCountInfo');
const wizStepEls = document.querySelectorAll('.wiz-step');

const pairGrid = document.getElementById('pairGrid');
const bowlA = document.getElementById('bowlA'), bowlB = document.getElementById('bowlB'), bowlC = document.getElementById('bowlC');
const countA = document.getElementById('countA'), countB = document.getElementById('countB'), countC = document.getElementById('countC');
const revealBall = document.getElementById('revealBall'), revealText = document.getElementById('revealText'), revealName = document.getElementById('revealName');
const revealOverlay = document.getElementById('revealOverlay'), rball = document.getElementById('rball'), rtext = document.getElementById('rtext');
const dismissReveal = document.getElementById('dismissReveal'), keepReveal = document.getElementById('keepReveal');
const confettiRoot = document.getElementById('confetti');

const btnUndo = document.getElementById('btnUndo'), btnExport = document.getElementById('btnExport'), btnObs = document.getElementById('btnObs'), musicToggle = document.getElementById('musicToggle');
const openWizard = document.getElementById('openWizard');

const audioDrum = document.getElementById('audioDrum'), audioPop = document.getElementById('audioPop'), audioApplause = document.getElementById('audioApplause'), audioGasp = document.getElementById('audioGasp'), audioBG = document.getElementById('audioBG');
const app = document.getElementById('app');

/* helpers */
function idGen(){ return 't'+Math.random().toString(36).slice(2,9); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function play(a){ try{ a.currentTime = 0; a.play(); }catch(e){} }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* ========== Wizard flow ========== */
let wizState = { step:1, cycle: 'cycle1', count: 14, selected: [] };

function showStep(n){
  wizStepEls.forEach(el=>el.classList.remove('active'));
  document.querySelector(`.wiz-step[data-step="${n}"]`).classList.add('active');
  wizState.step = n;
}

document.querySelectorAll('.option-cycle').forEach(o=>{
  o.addEventListener('click', ()=> {
    document.querySelectorAll('.option-cycle').forEach(x=>x.classList.remove('opt-selected'));
    o.classList.add('opt-selected');
    wizState.cycle = o.dataset.cycle;
  });
});

/* populate number options 6..14 */
function initNumOptions(){
  numOptions.innerHTML = '';
  for(let n=6;n<=14;n++){
    const d = document.createElement('div');
    d.className = 'option option-num';
    d.textContent = `${n} đội`;
    d.dataset.n = n;
    if(n===14) d.classList.add('opt-selected'), wizState.count=14;
    d.addEventListener('click', ()=>{ document.querySelectorAll('.option-num').forEach(x=>x.classList.remove('opt-selected')); d.classList.add('opt-selected'); wizState.count = n; updateTeamList(); });
    numOptions.appendChild(d);
  }
}

/* load teams.json and build team list */
async function loadAllTeams(){
  try{
    const r = await fetch('teams.json', {cache:'no-store'});
    const data = await r.json();
    allTeams = data.map((t,i)=>({ id:idGen(), name: t.name || `Đội ${i+1}`, logo: t.logo || '' }));
  }catch(e){
    // fallback sample
    allTeams = Array.from({length:14},(_,i)=>({ id:idGen(), name:`Đội ${i+1}`, logo:'' }));
  }
  updateTeamList();
}

/* render team checkbox list */
function updateTeamList(){
  const n = wizState.count || 14;
  teamList.innerHTML = '';
  teamCountInfo.textContent = `Chọn ${n} đội cho lần bốc này — mặc định chọn top ${n}`;
  // default: first n are checked; but allow uncheck
  for(let i=0;i<allTeams.length;i++){
    const t = allTeams[i];
    const row = document.createElement('label'); row.className='team-item';
    const chk = document.createElement('input'); chk.type='checkbox';
    // default behavior: check if within first n
    chk.checked = i < n;
    chk.dataset.tid = t.id;
    const img = document.createElement('img');
    // logo preview: if logo available and accessible, show; else show placeholder circle
    if(t.logo){
      img.src = t.logo;
      img.onerror = ()=>{ img.src = ''; img.style.background = '#2a3a4a'; img.textContent = t.name[0] || '?'; };
    } else {
      img.src = ''; img.style.background = '#2a3a4a';
    }
    const span = document.createElement('span'); span.textContent = ` ${t.name}`;
    row.appendChild(chk); row.appendChild(img); row.appendChild(span);
    teamList.appendChild(row);
  }
}

/* wizard button wiring */
document.getElementById('wizNext1').addEventListener('click', ()=> { showStep(2); });
document.getElementById('wizBack2').addEventListener('click', ()=>{ showStep(1); });
document.getElementById('wizNext2').addEventListener('click', ()=>{ showStep(3); });
document.getElementById('wizBack3').addEventListener('click', ()=>{ showStep(2); });
document.getElementById('wizFinish').addEventListener('click', ()=>{ // apply settings
  const checked = Array.from(teamList.querySelectorAll('input[type=checkbox]')).filter(i=>i.checked).map(i=>i.dataset.tid);
  // build selectedTeams from checked
  selectedTeams = allTeams.filter(t=>checked.includes(t.id)).slice(0, wizState.count);
  if(selectedTeams.length < 2){ alert('Phải chọn ít nhất 2 đội'); return; }
  // set globals
  currentCycle = wizState.cycle;
  selectedCount = wizState.count;
  wizard.style.display = 'none';
  startDrawWithSelected();
});

/* open wizard button */
openWizard.addEventListener('click', ()=>{ wizard.style.display='flex'; showStep(1); });

/* init wizard UI */
initNumOptions();
loadAllTeams();

/* ========== Draw setup ==========
  - prepare pots based on selectedTeams and distribution algorithm
  - build bracket slots depending on selectedCount
================================= */

function computeQuotas(n){
  const base = Math.floor(n/3);
  const rem = n % 3;
  const q = [ base + (rem>0?1:0), base + (rem>1?1:0), base ];
  // ensure sum == n
  let s = q[0]+q[1]+q[2];
  let i=0;
  while(s < n){ q[i%3]++; s++; i++; }
  return q;
}

function preparePotsFromSelected(){
  pots = [[],[],[]];
  const n = selectedTeams.length;
  const quotas = computeQuotas(n); // e.g. 14 -> [5,5,4]
  const idx = shuffle([...Array(n).keys()]);
  let p=0;
  idx.forEach(i=>{
    while(pots[p].length >= quotas[p]) p++;
    const t = Object.assign({}, selectedTeams[i]);
    t.pot = p;
    pots[p].push(t);
  });
  renderPots();
  buildPairsForCount(selectedTeams.length);
  updateCounts();
}

/* render pots (balls are blanks so no names shown) */
function renderPots(){
  bowlA.innerHTML=''; bowlB.innerHTML=''; bowlC.innerHTML='';
  pots[0].forEach((t,idx)=>{
    const b = document.createElement('div'); b.className = 'ball potA hidden'; b.dataset.tid=t.id; b.dataset.p=0; b.dataset.i=idx;
    b.setAttribute('aria-label', `Pot A vị trí ${idx+1}`);
    b.addEventListener('click', onBallClick);
    bowlA.appendChild(b);
  });
  pots[1].forEach((t,idx)=>{
    const b = document.createElement('div'); b.className = 'ball potB hidden'; b.dataset.tid=t.id; b.dataset.p=1; b.dataset.i=idx;
    b.setAttribute('aria-label', `Pot B vị trí ${idx+1}`);
    b.addEventListener('click', onBallClick);
    bowlB.appendChild(b);
  });
  pots[2].forEach((t,idx)=>{
    const b = document.createElement('div'); b.className = 'ball potC hidden'; b.dataset.tid=t.id; b.dataset.p=2; b.dataset.i=idx;
    b.setAttribute('aria-label', `Pot C vị trí ${idx+1}`);
    b.addEventListener('click', onBallClick);
    bowlC.appendChild(b);
  });
}

/* build bracket slots depending on count */
function buildPairsForCount(n){
  pairGrid.innerHTML = '';
  const pairs = Math.ceil(n/2);
  // grid layout: we will still show pairs in the existing grid but only create 'pairs' items
  for(let i=0;i<pairs;i++){
    const el = document.createElement('div'); el.className='pair'; el.dataset.i=i;
    el.innerHTML = `<div class="pair-row"><div class="slot"><div class="mini" id="mini-${i}-0">${i*2+1}</div><div class="name" id="n-${i}-0"><span class="placeholder">???</span></div></div><div class="vs">VS</div><div class="slot"><div class="name" id="n-${i}-1"><span class="placeholder">???</span></div><div class="mini" id="mini-${i}-1">${i*2+2}</div></div></div>`;
    pairGrid.appendChild(el);
  }
}

/* update counts */
function updateCounts(){
  countA.textContent = `${pots[0].length} đội`;
  countB.textContent = `${pots[1].length} đội`;
  countC.textContent = `${pots[2].length} đội`;
}

/* ========== Pairing memory (localStorage) ==========
   store pairings per cycle to avoid repeats across cycles
   stored as array of pairs like ["Team A|Team B"]
================================= */

function storePairing(cycleKey, a, b){
  const key = `vh_pairs_${cycleKey}`;
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push(`${a}||${b}`); // store canonical
  localStorage.setItem(key, JSON.stringify(arr));
}
function wasPairedBefore(a,b){
  // check cycle1 (previous cycles) depending on currentCycle
  const checkCycles = ['cycle1'];
  if(currentCycle === 'cycle3.2' || currentCycle === 'cycle3.3') {
    // avoid pairs that happened in cycle1
    checkCycles.push('cycle1');
  }
  for(const cyc of checkCycles){
    const key = `vh_pairs_${cyc}`;
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    if(arr.includes(`${a}||${b}`) || arr.includes(`${b}||${a}`)) return true;
  }
  return false;
}

/* ========== Draw logic ==========
  - clicking a ball removes it immediately
  - choose a random valid slot (avoid repeating pairings)
  - show cinematic overlay reveal
  - on dismiss: animate drop to bracket, update main reveal area (logo+name)
================================= */

async function onBallClick(e){
  const el = e.currentTarget;
  const potIndex = parseInt(el.dataset.p);
  const tid = el.dataset.tid;
  const pot = pots[potIndex];
  const idx = pot.findIndex(x=>x.id === tid);
  if(idx === -1) return;
  await doDraw(potIndex, idx);
}

async function drawFromPot(potIndex){
  if(!pots[potIndex] || pots[potIndex].length===0) return;
  const idx = Math.floor(Math.random() * pots[potIndex].length);
  await doDraw(potIndex, idx);
}

async function doDraw(potIndex, idxInPot){
  // remove ball
  const team = pots[potIndex].splice(idxInPot,1)[0];
  renderPots();
  updateCounts();

  // choose a random valid slot with constraints and avoid previous pairings
  const assigned = chooseRandomValidSlotAvoiding(team);
  // record current draw so overlay & dismiss handler can use it
  currentDraw = { team, assigned, fromPot: potIndex, ts: new Date().toISOString() };
  // store to history (we'll update bracket info after dismiss)
  history.push({ ts: currentDraw.ts, team: team.name, pot: team.pot, pairIndex: assigned ? assigned.pairIndex : null, side: assigned ? assigned.side : null, cycle: currentCycle });

  // cinematic overlay
  await cinematicRevealSequence(team);
}

/* chooseRandomValidSlotAvoiding(team) -> returns a candidate slot (random among candidates), avoids repeats */
function chooseRandomValidSlotAvoiding(team){
  const candidates = [];
  const pairs = Math.ceil(selectedTeams.length/2);
  for(let i=0;i<pairs;i++){
    const l = document.getElementById(`n-${i}-0`);
    const r = document.getElementById(`n-${i}-1`);
    const leftText = l ? l.textContent : '';
    const rightText = r ? r.textContent : '';

    // left empty? allowed if right empty OR right's pot != team.pot and not previously paired
    if(l && leftText.includes('???')){
      if(r && rightText && !rightText.includes('???')){
        // r occupied: check pot and previous pairing
        const rp = r.dataset.pot;
        if(String(rp) !== String(team.pot) && !wasPairedBefore(team.name, r.textContent)) candidates.push({pairIndex:i, side:0});
      } else {
        // both empty -> candidate
        candidates.push({pairIndex:i, side:0});
      }
    }

    // right empty?
    if(r && rightText.includes('???')){
      if(l && leftText && !leftText.includes('???')){
        const lp = l.dataset.pot;
        if(String(lp) !== String(team.pot) && !wasPairedBefore(team.name, l.textContent)) candidates.push({pairIndex:i, side:1});
      } else {
        candidates.push({pairIndex:i, side:1});
      }
    }
  }

  // remove duplicates
  const uniq = [];
  const keys = new Set();
  for(const c of candidates){
    const k = `${c.pairIndex}-${c.side}`;
    if(!keys.has(k)){ keys.add(k); uniq.push(c); }
  }
  if(uniq.length === 0){
    // fallback: any empty slot
    for(let i=0;i<pairs;i++){
      const l = document.getElementById(`n-${i}-0`), r = document.getElementById(`n-${i}-1`);
      if(l && l.textContent.includes('???')) return {pairIndex:i, side:0};
      if(r && r.textContent.includes('???')) return {pairIndex:i, side:1};
    }
    return {pairIndex:null, side:null};
  }
  return uniq[Math.floor(Math.random()*uniq.length)];
}

/* cinematic reveal overlay */
async function cinematicRevealSequence(team){
  // center small card update
  revealBall.innerHTML=''; // clear previous circle
  revealBall.style.background = (team.pot===0) ? 'var(--potA-grad)' : (team.pot===1 ? 'var(--potB-grad)' : 'var(--potC-grad)');
  revealName.textContent = 'MỞ QUẢ BÓNG...';
  revealText.querySelector('.small').textContent = 'Đang mở';
  play(audioDrum);
  await sleep(800);

  // overlay animation
  rball.innerHTML = ''; rball.style.backgroundImage = ''; rball.style.animation = 'ballUltraSpin 2.2s cubic-bezier(.1,.9,.2,1), ballExplosion 1.2s ease-in-out';
  rtext.textContent = 'ĐANG MỞ QUẢ BÓNG...';
  revealOverlay.style.display = 'flex';
  play(audioGasp);
  await sleep(1800);
  play(audioPop);
  await sleep(600);

  // reveal name + logo in overlay
  rball.style.animation = 'none';
  if(currentDraw.team.logo){
    // show logo as img inside rball
    rball.innerHTML = '';
    const img = document.createElement('img'); img.className='rlogo';
    img.src = currentDraw.team.logo;
    img.alt = currentDraw.team.name;
    // onerror -> hide img; will show text instead
    img.onerror = ()=>{ img.remove(); rball.textContent = currentDraw.team.name; };
    rball.appendChild(img);
  } else {
    rball.textContent = currentDraw.team.name;
  }
  rball.style.animation = 'textRevealEpic 0.9s ease-out';
  rtext.textContent = `CLAN: ${currentDraw.team.name}`;
  play(audioApplause);
  burstConfetti(140);
  cameraShake();

  // overlay remains until Dismiss; dismiss handler will drop into bracket and update main reveal
}

/* dismiss handler (drop to bracket + update main reveal area) */
async function onDismissHandler(){
  if(!currentDraw) { revealOverlay.style.display='none'; return; }

  // animate floating element from overlay center to bracket slot
  const assigned = currentDraw.assigned;
  if(assigned && assigned.pairIndex !== null){
    const targetEl = document.getElementById(`n-${assigned.pairIndex}-${assigned.side}`);
    // build floating box (logo+name)
    const float = document.createElement('div');
    float.style.position = 'fixed';
    float.style.left = (window.innerWidth/2 - 140) + 'px';
    float.style.top = (window.innerHeight/2 - 60) + 'px';
    float.style.padding = '8px 12px';
    float.style.borderRadius = '10px';
    float.style.background = 'linear-gradient(180deg,#ffffff,#f0f0f0)';
    float.style.color = '#021322';
    float.style.fontWeight = '800';
    float.style.boxShadow = '0 18px 60px rgba(0,0,0,0.6)';
    float.style.zIndex = 14000;

    if(currentDraw.team.logo){
      const img = document.createElement('img'); img.src = currentDraw.team.logo; img.style.height='36px'; img.style.width='36px'; img.style.objectFit='cover'; img.style.borderRadius='6px'; img.style.marginRight='8px'; float.appendChild(img);
      const txt = document.createElement('span'); txt.textContent = currentDraw.team.name; float.appendChild(txt);
    } else {
      float.textContent = currentDraw.team.name;
    }
    document.body.appendChild(float);

    const fromRect = float.getBoundingClientRect();
    const toRect = targetEl.getBoundingClientRect();
    const dx = (toRect.left + toRect.width/2) - (fromRect.left + fromRect.width/2);
    const dy = (toRect.top + toRect.height/2) - (fromRect.top + fromRect.height/2);

    float.animate([{ transform: 'translate(0,-8px) scale(1.03)', opacity:1 }, { transform: `translate(${dx}px, ${dy}px) scale(0.9)`, opacity:0}], { duration:900, easing:'cubic-bezier(.22,.9,.25,1)'});
    await sleep(920);

    // set bracket cell text + pot dataset
    targetEl.textContent = currentDraw.team.name;
    targetEl.dataset.pot = currentDraw.team.pot;
    // store pairing to localStorage for the current cycle to avoid repeats later
    // opponent may be on opposite cell; get opponent name
    const oppSide = assigned.side === 0 ? 1 : 0;
    const oppName = document.getElementById(`n-${assigned.pairIndex}-${oppSide}`).textContent;
    if(oppName && !oppName.includes('???')){
      storePairing(currentCycle, currentDraw.team.name, oppName);
    }
    targetEl.style.animation = 'dropFade .6s ease-out, bracketGlowStrong 1.2s ease-out';
    try{ float.remove(); }catch(e){}
  }

  // Update the small main reveal card to show logo + name persistently
  const mainCircle = revealBall;
  mainCircle.innerHTML = '';
  if(currentDraw.team.logo){
    const img = document.createElement('img'); img.className='reveal-logo';
    img.src = currentDraw.team.logo; img.alt = currentDraw.team.name;
    img.onerror = ()=>{ img.remove(); mainCircle.textContent = currentDraw.team.name; };
    mainCircle.appendChild(img);
  } else {
    mainCircle.textContent = currentDraw.team.name;
  }
  document.getElementById('revealName').textContent = currentDraw.team.name;
  revealText.querySelector('.small').textContent = `Đã mở: ${currentDraw.team.name}`;

  // finalize history already added; close overlay
  revealOverlay.style.display = 'none';

  // push pairing record in history
  // find last history entry and update (it was created in doDraw)
  const last = history[history.length-1];
  if(last && last.team === currentDraw.team.name && last.ts === currentDraw.ts) {
    last.pairedTo = null;
    if(currentDraw.assigned) { last.pairIndex = currentDraw.assigned.pairIndex; last.side = currentDraw.assigned.side; }
  }

  // clear current draw so next draw fresh (but main reveal still shows previous)
  currentDraw = null;
}

/* setup dismiss handlers once */
dismissReveal.addEventListener('click', onDismissHandler);
keepReveal.addEventListener('click', ()=>{ lastLocked = true; });

window.addEventListener('keydown', function(e){
  if(e.code === 'Space' || e.key === 'Enter'){
    if(revealOverlay.style.display === 'flex' && !lastLocked) onDismissHandler();
  }
});

/* mini countdown for tactile feel */
async function miniCountdown(sec=2){
  revealName.textContent = 'Chuẩn bị...';
  play(audioDrum);
  for(let i=sec;i>0;i--){
    revealBall.textContent = i;
    await sleep(700);
  }
  revealBall.textContent = '...';
}

/* confetti */
function burstConfetti(n=80){
  confettiRoot.innerHTML = '';
  const colors = ['#00e0ff','#ffd54d','#ff6b6b','#8ef0ff'];
  for(let i=0;i<n;i++){
    const p = document.createElement('div');
    p.style.position='absolute'; p.style.left = Math.random()*100 + '%'; p.style.top = '-8%';
    p.style.width = (6+Math.random()*10) + 'px'; p.style.height = (10+Math.random()*14) + 'px';
    p.style.background = colors[Math.floor(Math.random()*colors.length)]; p.style.opacity = 0.96; confettiRoot.appendChild(p);
    const dur = 1400 + Math.random()*2200;
    p.animate([{transform:`translateY(0) rotate(${Math.random()*360}deg)`},{transform:`translateY(${window.innerHeight+200}px) rotate(${Math.random()*720}deg)`}], { duration: dur, easing:'cubic-bezier(.2,.7,.3,1)'});
    setTimeout(()=>{ try{ p.remove(); }catch(e){} }, dur+220);
  }
}

/* camera shake */
function cameraShake(){
  app.style.animation = 'cameraShake 0.42s ease-in-out';
  setTimeout(()=> app.style.animation = 'none', 440);
}

/* Undo last */
function undoLast(){
  if(history.length === 0) return;
  const last = history.pop();
  // remove from bracket if exists
  for(let i=0;i<Math.ceil(selectedTeams.length/2);i++){
    for(let s=0;s<2;s++){
      const el = document.getElementById(`n-${i}-${s}`);
      if(el && el.textContent === last.team){
        el.textContent = '???'; delete el.dataset.pot;
        // return to pot array
        const pIndex = last.pot;
        pots[pIndex].push({ id:idGen(), name:last.team, logo:last.logo || '', pot:pIndex });
        renderPots();
        updateCounts();
        return;
      }
    }
  }
}

/* Export history */
function exportLog(){
  if(history.length === 0){ alert('Chưa có dữ liệu.'); return; }
  const jsonBlob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
  const csv = history.map(r=>`"${r.ts}","${r.team}","${r.pot}","${r.pairIndex}","${r.side}","${r.cycle || ''}"`).join('\n');
  const csvBlob = new Blob([csv], { type: 'text/csv' });
  downloadBlob(jsonBlob, 'vh_draw_log.json'); downloadBlob(csvBlob, 'vh_draw_log.csv');
}
function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 600); }

/* ========== Utility: start draw after wizard settings applied ========== */
function startDrawWithSelected(){
  // if selectedTeams empty, use all
  if(!selectedTeams || selectedTeams.length === 0) selectedTeams = allTeams.slice(0, selectedCount);
  // prepare pots & bracket
  preparePotsFromSelected();
  // persist currentCycle selection to global
  // we leave wizard closed
}

/* setup hotkeys and UI wiring */
btnUndo.addEventListener('click', undoLast);
btnExport.addEventListener('click', exportLog);
btnObs.addEventListener('click', ()=>{
  const on = document.body.style.background === 'transparent';
  if(!on){ document.querySelectorAll('.controls, .btn').forEach(x=>x.classList.add('obsHide')); document.body.style.background='transparent'; btnObs.textContent='OBS: ON'; }
  else { document.querySelectorAll('.controls, .btn').forEach(x=>x.classList.remove('obsHide')); document.body.style.background=''; btnObs.textContent='OBS: OFF'; }
});
musicToggle.addEventListener('change', (e)=>{ if(e.target.checked) audioBG.play(); else audioBG.pause(); });

// hotkeys
window.addEventListener('keydown', async (e)=>{
  if(e.key === '1') await drawFromPot(0);
  if(e.key === '2') await drawFromPot(1);
  if(e.key === '3') await drawFromPot(2);
  if(e.key === 'u') undoLast();
  if(e.key === 'x') exportLog();
  if((e.code === 'Space' || e.key === 'Enter') && revealOverlay.style.display === 'flex' && !lastLocked) onDismissHandler();
});

/* ================= init default: show wizard on first load ================= */
showStep(1);
wizard.style.display = 'flex';
</script>
</body>
</html>
